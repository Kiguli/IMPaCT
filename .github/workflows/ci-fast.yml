name: Fast CI - Smoke Tests

on:
  push:
    branches: ["*"]
    paths-ignore: ["**.md", "docs/**"]
  pull_request:
    branches: ["main", "develop"]
    paths-ignore: ["**.md", "docs/**"]

jobs:
  smoke-test:
    name: "Smoke Test: ${{ matrix.example }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        example:
          - ex_2Drobot-R-U
          - ex_2Drobot-R-D
          - ex_4DBAS-S

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install pyyaml h5py numpy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            clang-16 \
            libblas-dev \
            liblapack-dev \
            libnlopt-dev \
            libopenblas-dev \
            libhdf5-serial-dev \
            libomp-16-dev \
            libglpk-dev \
            libgsl-dev \
            libarmadillo-dev \
            libboost-all-dev

      - name: Compile example
        id: compile
        timeout-minutes: 5
        run: |
          cd examples/${{ matrix.example }}
          make
        continue-on-error: true

      - name: Run example
        id: run
        if: steps.compile.outcome == 'success'
        timeout-minutes: 3
        run: |
          cd examples/${{ matrix.example }}
          # Find the executable (first file without extension or with no .cpp/.h extension)
          EXECUTABLE=$(ls | grep -v '\.' | head -n 1 || ls *.out 2>/dev/null | head -n 1 || echo "")
          if [ -z "$EXECUTABLE" ]; then
            # Try to infer from directory name
            DIR_NAME=$(basename $(pwd))
            EXECUTABLE=$(echo $DIR_NAME | sed 's/ex_//' | sed 's/-R-U//' | sed 's/-R-D//' | sed 's/-S//')
            # Common executable names
            if [ ! -f "$EXECUTABLE" ]; then
              EXECUTABLE="robot2D"
            fi
          fi
          echo "Running: ./$EXECUTABLE"
          ./$EXECUTABLE
        continue-on-error: true

      - name: Check outputs
        id: validate
        if: steps.run.outcome == 'success'
        run: |
          cd examples/${{ matrix.example }}
          echo "Checking for HDF5 output files..."
          H5_FILES=$(ls *.h5 2>/dev/null | wc -l)
          echo "Found $H5_FILES HDF5 files"
          if [ "$H5_FILES" -gt 0 ]; then
            ls -lh *.h5
            echo "✅ Output validation passed"
          else
            echo "❌ No HDF5 output files found"
            exit 1
          fi

      - name: Upload outputs
        if: steps.run.outcome == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: outputs-${{ matrix.example }}
          path: examples/${{ matrix.example }}/*.h5
          retention-days: 7

      - name: Report status
        if: always()
        run: |
          echo "## Test Results: ${{ matrix.example }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Compilation: ${{ steps.compile.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Execution: ${{ steps.run.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.compile.outcome }}" = "success" ] && [ "${{ steps.run.outcome }}" = "success" ] && [ "${{ steps.validate.outcome }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All checks passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: smoke-test
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Smoke Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All smoke tests completed. Check individual test results above." >> $GITHUB_STEP_SUMMARY

          # Note: In a real scenario, you'd aggregate results from the matrix jobs
          # For now, we'll just indicate the workflow completed
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested examples:" >> $GITHUB_STEP_SUMMARY
          echo "- ex_2Drobot-R-U" >> $GITHUB_STEP_SUMMARY
          echo "- ex_2Drobot-R-D" >> $GITHUB_STEP_SUMMARY
          echo "- ex_4DBAS-S" >> $GITHUB_STEP_SUMMARY
